# Maintainer/Originator: Jake VanderKolk <jakevanderkolk@gmail.com>
pkgname=hostsblock
pkgver=0.999.8.1
pkgrel=1
pkgdesc="An ad- and malware-blocking utility for POSIX systems"
arch=(any)
url="https://github.com/gaenserich/hostsblock"
license=('GPL')
depends=(sh curl grep sed coreutils findutils)
optdepends=('dnsmasq: helps speed up DNS resolutions'
	    'pixelserv: removes boilerplate page on blocked urls'
	    'kwakd: removes boilerplate page on blocked urls (recommended)'
        'pixelserv-tls: removes boilerplate page on blocked urls (supports HTTPS)'
	    'unzip: allows the use of zipped downloads'
	    'p7zip: allows the use of 7zipped downloads')
source=(https://github.com/gaenserich/hostsblock/archive/v$pkgver.tar.gz)
changelog=$pkgname.changelog
install=$pkgname.install
sha1sums=('ad67ce3f45cc5a4b967f5c9e3af6ef8d65b56fa1')
SYSTEMD_DIR="/usr/lib/systemd/system"
SYSTEMCTLPATH="/usr/bin/systemctl"
SHPATH="/usr/bin/sh"
_HOME="$pkgdir/var/lib/hostsblock"

_mkdir() {
    # $1 = dir to be made; $2 = chmod hex
    if [ ! -d "$1" ]; then
        mkdir -p -m "$2" "$1"
    fi
}

_install() {
    #$1 = source; $2 = destination; $3 = chmod hex
    sed -e "s/%PREFIX%/$PREFIX/g" -e "s/%SYSTEMCTLPATH%/$SYSTEMCTLPATH/g" -e "s/%SHPATH%/$SHPATH/g" -e "s/%_HOME%/$_HOME/g" "$1" > "$2"
    chmod "$3" "$2"
}


package() {
  cd "$srcdir"/"$pkgname"-"$pkgver"
  _mkdir "$_HOME" 755
  _install src/hostsblock.sh "$pkgdir"/usr/lib/hostsblock.sh 500
  _install src/hostsblock-wrapper.sh "$pkgdir"/usr/bin/hostsblock 550
  _mkdir "$_HOME"/config.examples 700
  for _conffile in hostsblock.conf black.list white.list hosts.head block.urls redirect.urls; do
    _install conf/"$_conffile" "$_HOME"/config.examples/"$_conffile" 600
  done
  _mkdir "$SYSTEMD_DIR" 755
  for _sysdfile in hostsblock.service hostsblock.timerhostsblock-dnsmasq-restart.path hostsblock-dnsmasq-restart.service hostsblock-hosts-clobber.path hostsblock-hosts-clobber.service; do
    _install systemd/"$_sysdfile" "$pkgdir"/usr/lib/systemd/system/"$_sysdfile" 444
  done
}
